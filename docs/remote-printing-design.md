# 远程打印系统构思（Rust）

## 目标与边界
- 目标：在连接物理打印机的电脑上运行服务端，客户端通过一次配置即可远程打印。
- 支持：多客户端、多个虚拟打印机映射、按 IP/主机名连接、双面打印（Duplex）。
- 非目标（可后续迭代）：复杂的账号体系、计费系统、跨公网的零配置穿透。

## 总体架构
- 服务端（Printer Host）
  - 运行在连接物理打印机的电脑上。
  - 提供：打印队列管理、驱动能力探测、作业状态回调、权限控制。
- 客户端（Printer Client）
  - 在远程电脑上创建一个或多个“虚拟打印机”。
  - 用户选择虚拟打印机打印时，客户端把作业封装并传给服务端。
- 协议与数据
  - 控制面：作业提交、状态查询、能力查询、心跳。
  - 数据面：打印作业二进制流（PDF/PS/RAW）。

## 关键流程
1. **初次配置**
   - 客户端输入服务端 IP/主机名与端口。
   - 客户端向服务端拉取打印机列表与能力（纸张、颜色、双面等）。
   - 客户端为每个远程打印机创建本地虚拟打印机并缓存能力。
2. **打印作业**
   - 用户选择虚拟打印机，打印系统生成作业（建议 PDF）。
   - 客户端发送作业元数据 + 内容流到服务端。
   - 服务端将作业转入本地打印队列并记录状态。
3. **状态回传**
   - 服务端推送或客户端轮询作业状态（队列中/打印中/完成/失败）。

## 双面打印（Duplex）支持
- 能力探测：服务端在启动或连接时读取物理打印机能力（支持长边/短边）。
- 作业参数：客户端提交作业时携带 duplex 字段（none/long-edge/short-edge）。
- 兼容策略：
  - 若目标打印机不支持双面，则返回可理解错误或降级为单面。
  - 客户端 UI 中根据能力动态展示选项。

## 作业格式建议
- 优先 PDF：跨平台一致性高。
- 备选：RAW/EMF/PS（取决于平台与驱动）
- 服务器可选做简单转换，但初期建议直接传递可打印格式。

## 模块划分（Rust）
- `server`
  - API：HTTP/gRPC 接口（提交作业、查询状态、获取能力）。
  - Print Engine：调用平台打印 API（Windows: Win32 Print Spooler）。
  - Queue：作业入队、状态追踪、失败重试。
- `client`
  - Virtual Printer：创建/管理虚拟打印机（Windows: printer driver 或 XPS virtual printer）。
  - Spooler Hook：拦截作业输出并转发服务端。
  - Config：服务端地址、证书/密钥、已映射打印机配置。
- `common`
  - 协议结构、错误码、能力模型、作业元数据。

## 协议草案（控制面）
- `GET /printers`：列出打印机与能力
- `POST /jobs`：提交作业（metadata + stream）
- `GET /jobs/{id}`：查询作业状态
- `POST /jobs/{id}/cancel`：取消作业

## 安全与权限
- 基础：Token + TLS（自签证书或内网 CA）
- 权限：按客户端授权打印机访问
- 日志审计：记录作业提交与打印结果

## 可扩展点
- 多服务端发现：mDNS/局域网广播
- 断点续传：大作业分片上传
- 作业预览与计数：页数/纸张统计
- 可选的 web 管理界面

## 技术风险与验证点
- 虚拟打印机实现复杂度（Windows 驱动/端口监视器）
- 作业格式兼容性（不同应用输出）
- 双面打印参数在不同驱动中的映射

## 初期里程碑
1. POC：服务端 API + 客户端 CLI 传 PDF 到服务端打印
2. Windows 客户端虚拟打印机 PoC
3. 状态回传与错误处理
4. 双面/纸张/颜色能力完整链路
5. 稳定性与安全完善
